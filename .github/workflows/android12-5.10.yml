name: Android12-5.10

on:
  workflow_dispatch:
    inputs:
      os_patch_level:
        required: true
        type: string
        description: >
          Tag suffix for Kernel Source & Boot Image.
          Example: 2024-08_r9
      os_version:
        required: true
        type: string
        description: >
          OS Version of boot image,
          Example: 12.0.0
      version_name:
        required: true
        type: string
        description: >
          Custom name for filename,
          Example: android12-5.10.209
      custom:
        required: true
        type: boolean
        description: >
          Enable LXC, Docker config
      kernelsu:
        required: true
        type: boolean
        description: >
          Enable KernelSU

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y repo wget bc bison flex build-essential python3-pip git zip unzip
        git config --global credential.helper store

    - name: Sync the kernel source code
      run: |
        mkdir -p $GITHUB_WORKSPACE/android-kernel
        cd $GITHUB_WORKSPACE/android-kernel
        
        # 修正关键点 1: repo init 使用固定的分支名 'common-android12-5.10'
        # 这个分支在 Manifest 仓库里是 100% 存在的
        repo init --depth 1 -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10
        
        # 同步代码
        repo sync -j$(nproc) --fail-fast
        
        # 修正关键点 2: (可选) 强制将 kernel/common 切换到你指定的 Tag
        # 这样你的源码就和你要下载的 Boot 镜像版本 (_r9) 完全一致了
        echo "Checking out specific kernel tag: android12-5.10-${{ inputs.os_patch_level }}"
        cd common
        git fetch --tags https://android.googlesource.com/kernel/common android12-5.10-${{ inputs.os_patch_level }}
        git checkout android12-5.10-${{ inputs.os_patch_level }}

    - name: Apply patches and configuration files
      if: ${{ inputs.custom == true }}
      run: |
        # 不需要 git clone，因为代码已经在 $GITHUB_WORKSPACE 里了
        
        # 1. 复制配置文件 (注意路径去掉了 gki-patch/)
        # 假设你的仓库根目录下有 config 文件夹
        cp $GITHUB_WORKSPACE/config/gki_defconfig-android12-5.10 $GITHUB_WORKSPACE/android-kernel/common/arch/arm64/configs/gki_defconfig
        
        # 2. 应用补丁 (注意路径去掉了 gki-patch/)
        # 假设你的仓库根目录下有 patchs 文件夹
        if [ -d "$GITHUB_WORKSPACE/patchs" ] && [ "$(ls -A $GITHUB_WORKSPACE/patchs/*.patch 2>/dev/null)" ]; then
            cd $GITHUB_WORKSPACE/android-kernel/common
            git apply $GITHUB_WORKSPACE/patchs/*.patch
        else
            echo "No patches found or patch directory missing."
        fi

    - name: In-place patch kernel/module.c
      run: |
        cd $GITHUB_WORKSPACE/android-kernel/common
        
        # 1. Modify the warning message
        sed -i 's/disagrees about version of symbol %s\\n/disagrees about version of symbol %s, but ignore...\\n/g' kernel/module.c
        
        # 2. Modify the return value specifically in the bad_version block
        # This looks for the line 'bad_version:' and changes the 'return 0;' that follows it.
        sed -i '/bad_version:/,/}/ s/return 0;/return 1;/' kernel/module.c
        
        # 3. Verify the changes (this will print the changes to the Action logs so you can check)
        echo "Verification: Checking modified code block..."
        grep -A 5 "bad_version:" kernel/module.c

    - name: KernelSU
      if: ${{ inputs.kernelsu == true }}
      run: |
        cd $GITHUB_WORKSPACE/android-kernel/common
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Build Kernel
      run: |
        cd $GITHUB_WORKSPACE/android-kernel
        BUILD_CONFIG=common/build.config.gki.aarch64 build/config.sh savedefconfig
        LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh

    - name: Prepare artifacts
      id: prepareArtifacts
      run: |
        cd $GITHUB_WORKSPACE
        OUTDIR=android-kernel/out/android12-5.10/dist
        mkdir output
        
        if [ -f "$OUTDIR/Image" ]; then cp $OUTDIR/Image ./output/; fi
        if [ -f "$OUTDIR/Image.lz4" ]; then cp $OUTDIR/Image.lz4 ./output/; fi
        cp $OUTDIR/Image ./
        gzip -n -k -f -9 Image > Image.gz
        
        git clone https://github.com/Kernel-SU/AnyKernel3
        rm -rf ./AnyKernel3/.git
        cp $OUTDIR/Image ./AnyKernel3/
        cd AnyKernel3
        zip -r9 ../output/AnyKernel3-${{ inputs.version_name }}.zip * -x .git README.md *placeholder
        cd ..

        # 下载官方 Boot 镜像 (使用输入的完整后缀，如 2024-08_r9)
        wget https://dl.google.com/android/gki/gki-certified-boot-android12-5.10-${{ inputs.os_patch_level }}.zip -O ./gki-kernel.zip
        unzip -q ./gki-kernel.zip -d ./boot-img-source
        rm ./gki-kernel.zip
        
        cd $GITHUB_WORKSPACE/android-kernel
        echo "Unpack boot"
        ./tools/mkbootimg/unpack_bootimg.py --boot_img $GITHUB_WORKSPACE/boot-img-source/boot-*.img
        
        echo "Build boot.img"
        # 注意: --os_patch_level 只要年份月份即可，不需要 _r9，这里用 shell 截取一下前7位 (例如 2024-08)
        PATCH_LEVEL_SHORT=$(echo "${{ inputs.os_patch_level }}" | cut -d'_' -f1)
        
        ./tools/mkbootimg/mkbootimg.py --header_version 4 --kernel out/android12-5.10/dist/Image --ramdisk out/ramdisk --os_version ${{ inputs.os_version }} --os_patch_level $PATCH_LEVEL_SHORT -o $GITHUB_WORKSPACE/output/${{ inputs.version_name }}_${{ inputs.os_patch_level }}-boot.img
        
        echo "Build boot-lz4.img"
        ./tools/mkbootimg/mkbootimg.py --header_version 4 --kernel out/android12-5.10/dist/Image.lz4 --ramdisk out/ramdisk --os_version ${{ inputs.os_version }} --os_patch_level $PATCH_LEVEL_SHORT -o $GITHUB_WORKSPACE/output/${{ inputs.version_name }}_${{ inputs.os_patch_level }}-boot-lz4.img
        
        echo "Build boot-gz.img"
        ./tools/mkbootimg/mkbootimg.py --header_version 4 --kernel $GITHUB_WORKSPACE/Image.gz --ramdisk out/ramdisk --os_version ${{ inputs.os_version }} --os_patch_level $PATCH_LEVEL_SHORT -o $GITHUB_WORKSPACE/output/${{ inputs.version_name }}_${{ inputs.os_patch_level }}-boot-gz.img

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Result-${{ inputs.version_name }}-${{ inputs.os_patch_level }}
        path: ./output/*
